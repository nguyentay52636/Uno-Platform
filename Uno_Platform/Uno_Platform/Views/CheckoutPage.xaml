<Page x:Class="Uno_Platform.Views.CheckoutPage"
      x:Name="PageRoot"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:models="using:Uno_Platform.Models"
      xmlns:converters="using:Uno_Platform.Converters"
      xmlns:components="using:Uno_Platform.Components"
      Background="#F5F5F5">

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- Header -->
    <Border Grid.Row="0"
            Background="#3D5A5B"
            Padding="16">
      <Grid ColumnDefinitions="Auto,*">
        <Button Grid.Column="0"
                Background="Transparent"
                Padding="8"
                MinWidth="0"
                MinHeight="0"
                Command="{x:Bind ViewModel.GoBackCommand}">
          <FontIcon Glyph="&#xE72B;" FontSize="20" Foreground="White"/>
        </Button>
        
        <TextBlock Grid.Column="1"
                   Text="Thanh toán"
                   FontSize="20"
                   FontWeight="Bold"
                   Foreground="White"
                   VerticalAlignment="Center"
                   Margin="12,0,0,0"/>
      </Grid>
    </Border>

    <!-- Content -->
    <ScrollViewer Grid.Row="1" 
                  Padding="12"
                  VerticalScrollBarVisibility="Auto">
      <StackPanel Spacing="16">
        
        <!-- Section: Shipping Info -->
        <Border Background="White"
                Padding="16"
                CornerRadius="16">
          <StackPanel Spacing="16">
            <StackPanel Orientation="Horizontal" Spacing="10">
              <Border Background="#F0F7F7" 
                      CornerRadius="10" 
                      Width="36" Height="36">
                <FontIcon Glyph="&#xE77B;" FontSize="18" Foreground="#3D5A5B"
                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
              </Border>
              <TextBlock Text="Thông tin giao hàng"
                         FontSize="18"
                         FontWeight="Bold"
                         Foreground="#3D5A5B"
                         VerticalAlignment="Center"/>
            </StackPanel>
            
            <TextBox Header="Họ và tên"
                     Text="{x:Bind ViewModel.CustomerName, Mode=TwoWay}"
                     PlaceholderText="Nguyễn Văn A"
                     FontSize="15"
                     CornerRadius="10"
                     Padding="12"/>

            <TextBox Header="Số điện thoại"
                     Text="{x:Bind ViewModel.CustomerPhone, Mode=TwoWay}"
                     PlaceholderText="0901234567"
                     InputScope="TelephoneNumber"
                     FontSize="15"
                     CornerRadius="10"
                     Padding="12"/>

            <TextBox Header="Địa chỉ nhận hàng"
                     Text="{x:Bind ViewModel.CustomerAddress, Mode=TwoWay}"
                     PlaceholderText="Số nhà, đường, phường/xã..."
                     AcceptsReturn="True"
                     TextWrapping="Wrap"
                     MinHeight="80"
                     FontSize="15"
                     CornerRadius="10"
                     Padding="12"/>
          </StackPanel>
        </Border>

        <!-- Section: Order Items -->
        <Border Background="White"
                Padding="16"
                CornerRadius="16">
          <StackPanel Spacing="16">
            <StackPanel Orientation="Horizontal" Spacing="10">
              <Border Background="#F0F7F7" 
                      CornerRadius="10" 
                      Width="36" Height="36">
                <FontIcon Glyph="&#xE7BF;" FontSize="18" Foreground="#3D5A5B"
                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
              </Border>
              <TextBlock Text="Đơn hàng của bạn"
                         FontSize="18"
                         FontWeight="Bold"
                         Foreground="#3D5A5B"
                         VerticalAlignment="Center"/>
            </StackPanel>

            <!-- Cart Items List -->
            <ItemsControl ItemsSource="{x:Bind ViewModel.CartItems, Mode=OneWay}">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <StackPanel Spacing="12"/>
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="models:CartItem">
                  <Border Background="#FAFAFA"
                          CornerRadius="12"
                          Padding="12">
                    <Grid ColumnDefinitions="Auto,*">
                      
                      <!-- Product Image -->
                      <Border Grid.Column="0"
                              Width="80"
                              Height="80"
                              Background="#FDF5F0"
                              CornerRadius="10"
                              Margin="0,0,12,0">
                        <Image Source="{x:Bind ProductImage, Mode=OneWay}"
                               Stretch="Uniform"
                               MaxHeight="60"
                               MaxWidth="60"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>
                      </Border>

                      <!-- Product Info -->
                      <Grid Grid.Column="1" RowDefinitions="Auto,Auto,Auto">
                        
                        <!-- Product Name -->
                        <TextBlock Grid.Row="0"
                                   Text="{x:Bind ProductName, Mode=OneWay}"
                                   FontSize="15"
                                   FontWeight="Bold"
                                   Foreground="#1A1A1A"
                                   TextTrimming="CharacterEllipsis"
                                   MaxLines="2"/>
                        
                        <!-- Price x Quantity -->
                        <StackPanel Grid.Row="1" 
                                    Orientation="Horizontal" 
                                    Spacing="6"
                                    Margin="0,4,0,0">
                          <TextBlock Text="{x:Bind ProductPrice, Mode=OneWay, Converter={StaticResource PriceFormatConverter}}"
                                     FontSize="13"
                                     Foreground="#3D5A5B"
                                     FontWeight="SemiBold"/>
                          <TextBlock Text="×" FontSize="13" Foreground="#888"/>
                          <Border Background="#3D5A5B"
                                  CornerRadius="6"
                                  Padding="8,2">
                            <TextBlock Text="{x:Bind Quantity, Mode=OneWay}"
                                       FontSize="13"
                                       FontWeight="Bold"
                                       Foreground="White"/>
                          </Border>
                        </StackPanel>
                        
                        <!-- Item Total -->
                        <StackPanel Grid.Row="2" 
                                    Orientation="Horizontal"
                                    Margin="0,8,0,0">
                          <TextBlock Text="Thành tiền: "
                                     FontSize="13"
                                     Foreground="#666"/>
                          <TextBlock Text="{x:Bind TotalPrice, Mode=OneWay, Converter={StaticResource PriceFormatConverter}}"
                                     FontSize="15"
                                     FontWeight="Bold"
                                     Foreground="#3D5A5B"/>
                        </StackPanel>
                      </Grid>
                      
                    </Grid>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </StackPanel>
        </Border>

        <!-- Error Message -->
        <Border Background="#FEE2E2"
                CornerRadius="12"
                Padding="16"
                Visibility="{x:Bind ViewModel.ErrorMessage, Converter={StaticResource StringToVisibilityConverter}, Mode=OneWay}">
          <StackPanel Orientation="Horizontal" Spacing="10">
            <FontIcon Glyph="&#xE783;" FontSize="18" Foreground="#EF4444"/>
            <TextBlock Text="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                       FontSize="14"
                       Foreground="#EF4444"
                       TextWrapping="Wrap"
                       VerticalAlignment="Center"/>
          </StackPanel>
        </Border>
        
      </StackPanel>
    </ScrollViewer>

    <!-- Bottom Summary & Submit -->
    <Border Grid.Row="2"
            Background="White"
            Padding="16"
            BorderThickness="0,1,0,0"
            BorderBrush="#E8E8E8">
      <Grid RowDefinitions="Auto,Auto">
        
        <!-- Total Row -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,12">
          <StackPanel Grid.Column="0">
            <TextBlock Text="Tổng cộng"
                       FontSize="14"
                       Foreground="#666"/>
            <TextBlock FontSize="12" Foreground="#888">
              <Run Text="{x:Bind ViewModel.CartItems.Count, Mode=OneWay}"/>
              <Run Text=" sản phẩm"/>
            </TextBlock>
          </StackPanel>
          <TextBlock Grid.Column="1"
                     Text="{x:Bind ViewModel.TotalPriceFormatted, Mode=OneWay}"
                     FontSize="24"
                     FontWeight="Bold"
                     Foreground="#3D5A5B"
                     VerticalAlignment="Center"/>
        </Grid>
        
        <!-- Submit Button -->
        <Button Grid.Row="1"
                Background="#3D5A5B"
                Foreground="White"
                CornerRadius="12"
                Padding="0,14"
                HorizontalAlignment="Stretch"
                Command="{x:Bind ViewModel.SubmitOrderCommand}">
          <Grid ColumnDefinitions="Auto,*">
            <ProgressRing Grid.Column="0"
                          IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                          Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}"
                          Width="20" Height="20"
                          Foreground="White"
                          Margin="0,0,10,0"/>
            <TextBlock Grid.Column="1" 
                       Text="✓ Xác nhận đặt hàng" 
                       FontSize="16" 
                       FontWeight="Bold"
                       HorizontalAlignment="Center"/>
          </Grid>
        </Button>
      </Grid>
    </Border>

    <!-- Loading Overlay -->
    <components:LoadingIndicator Grid.RowSpan="3"
                                IsLoading="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                                Message="Đang xử lý..."/>
  </Grid>
</Page>
