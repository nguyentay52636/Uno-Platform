<Page x:Class="Uno_Platform.Views.CheckoutPage"
      x:Name="PageRoot"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:models="using:Uno_Platform.Models"
      xmlns:converters="using:Uno_Platform.Converters"
      xmlns:components="using:Uno_Platform.Components"
      Background="#F5F5F5">

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- Header -->
    <Border Grid.Row="0"
            Background="#367419"
            Padding="16">
      <Grid ColumnDefinitions="Auto,*">
        <Button Grid.Column="0"
                Style="{StaticResource NoHoverIconButtonStyle}"
                Command="{x:Bind ViewModel.GoBackCommand}">
          <FontIcon Glyph="&#xE72B;" FontSize="20" Foreground="White"/>
        </Button>
        
        <TextBlock Grid.Column="1"
                   Text="Thanh toán"
                   FontSize="20"
                   FontWeight="Bold"
                   Foreground="White"
                   VerticalAlignment="Center"
                   Margin="12,0,0,0"/>
      </Grid>
    </Border>

    <!-- Content -->
    <ScrollViewer Grid.Row="1" 
                  Padding="12"
                  VerticalScrollBarVisibility="Auto">
      <StackPanel Spacing="12">
        
        <!-- Section: Shipping Info - Compact -->
        <Border Background="White"
                Padding="14"
                CornerRadius="12">
          <StackPanel Spacing="12">
            <!-- Header -->
            <StackPanel Orientation="Horizontal" Spacing="8">
              <Border Background="#E8F5E9" 
                      CornerRadius="8" 
                      Width="28" Height="28">
                <FontIcon Glyph="&#xE77B;" FontSize="14" Foreground="#367419"
                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
              </Border>
              <TextBlock Text="Thông tin giao hàng"
                         FontSize="15"
                         FontWeight="Bold"
                         Foreground="#367419"
                         VerticalAlignment="Center"/>
            </StackPanel>
            
            <!-- Họ và tên -->
            <StackPanel Spacing="4">
              <StackPanel Orientation="Horizontal" Spacing="2">
                <TextBlock Text="Họ và tên"
                           FontSize="12"
                           FontWeight="SemiBold"
                           Foreground="#555"/>
                <TextBlock Text="*" FontSize="12" Foreground="#EF4444"/>
              </StackPanel>
              <Border Background="#F8F9FA"
                      BorderBrush="#E0E0E0"
                      BorderThickness="1"
                      CornerRadius="8"
                      Padding="10,8">
                <TextBox Text="{x:Bind ViewModel.CustomerName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         PlaceholderText="Nhập tên khách hàng"
                         PlaceholderForeground="#666666"
                         FontSize="13"
                         Foreground="#1A1A1A"
                         Background="Transparent"
                         BorderThickness="0"/>
              </Border>
            </StackPanel>

            <!-- Số điện thoại -->
            <StackPanel Spacing="4">
              <StackPanel Orientation="Horizontal" Spacing="2">
                <TextBlock Text="Số điện thoại"
                           FontSize="12"
                           FontWeight="SemiBold"
                           Foreground="#555"/>
                <TextBlock Text="*" FontSize="12" Foreground="#EF4444"/>
              </StackPanel>
              <Border Background="#F8F9FA"
                      BorderBrush="#E0E0E0"
                      BorderThickness="1"
                      CornerRadius="8"
                      Padding="10,8">
                <TextBox Text="{x:Bind ViewModel.CustomerPhone, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         PlaceholderText="SĐT có 10-11 chữ số"
                         PlaceholderForeground="#666666"
                         InputScope="TelephoneNumber"
                         FontSize="13"
                         Foreground="#1A1A1A"
                         Background="Transparent"
                         BorderThickness="0"/>
              </Border>
            </StackPanel>

            <!-- Địa chỉ nhận hàng -->
            <StackPanel Spacing="4">
              <StackPanel Orientation="Horizontal" Spacing="2">
                <TextBlock Text="Địa chỉ giao hàng"
                           FontSize="12"
                           FontWeight="SemiBold"
                           Foreground="#555"/>
                <TextBlock Text="*" FontSize="12" Foreground="#EF4444"/>
              </StackPanel>
              <Border Background="#F8F9FA"
                      BorderBrush="#E0E0E0"
                      BorderThickness="1"
                      CornerRadius="8"
                      Padding="10,8">
                <TextBox Text="{x:Bind ViewModel.CustomerAddress, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         PlaceholderText="Số nhà, đường, phường, quận, TP"
                         PlaceholderForeground="#666666"
                         AcceptsReturn="True"
                         TextWrapping="Wrap"
                         MinHeight="40"
                         FontSize="13"
                         FontStyle="Normal"
                         Foreground="#1A1A1A"
                         Background="Transparent"
                         BorderThickness="0"/>
              </Border>
            </StackPanel>

            <!-- Ghi chú (không bắt buộc) -->
            <StackPanel Spacing="4">
              <TextBlock Text="Ghi chú (không bắt buộc)"
                         FontSize="12"
                         Foreground="#888"/>
              <Border Background="#F8F9FA"
                      BorderBrush="#E0E0E0"
                      BorderThickness="1"
                      CornerRadius="8"
                      Padding="10,8">
                <TextBox PlaceholderText="Thêm ghi chú"
                         PlaceholderForeground="#666666"
                         AcceptsReturn="True"
                         TextWrapping="Wrap"
                         MinHeight="36"
                         FontSize="13"
                         Foreground="#1A1A1A"
                         Background="Transparent"
                         BorderThickness="0"/>
              </Border>
            </StackPanel>
          </StackPanel>
        </Border>

        <!-- Section: Order Items - Compact -->
        <Border Background="White"
                Padding="14"
                CornerRadius="12">
          <StackPanel Spacing="10">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <Border Background="#E8F5E9" 
                      CornerRadius="8" 
                      Width="28" Height="28">
                <FontIcon Glyph="&#xE7BF;" FontSize="14" Foreground="#367419"
                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
              </Border>
              <TextBlock Text="Đơn hàng của bạn"
                         FontSize="15"
                         FontWeight="Bold"
                         Foreground="#367419"
                         VerticalAlignment="Center"/>
            </StackPanel>

            <!-- Cart Items List - Compact -->
            <ItemsControl ItemsSource="{x:Bind ViewModel.CartItems, Mode=OneWay}">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <StackPanel Spacing="8"/>
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="models:CartItem">
                  <Border Background="#FAFAFA"
                          CornerRadius="10"
                          Padding="10">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                      
                      <!-- Product Image -->
                      <Border Grid.Column="0"
                              Width="50"
                              Height="50"
                              Background="#E8F5E9"
                              CornerRadius="8"
                              Margin="0,0,10,0">
                        <Image Source="{x:Bind ProductImage, Mode=OneWay}"
                               Stretch="Uniform"
                               MaxHeight="40"
                               MaxWidth="40"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>
                      </Border>

                      <!-- Product Info -->
                      <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock Text="{x:Bind ProductName, Mode=OneWay}"
                                   FontSize="13"
                                   FontWeight="SemiBold"
                                   Foreground="#1A1A1A"
                                   TextTrimming="CharacterEllipsis"
                                   MaxLines="1"/>
                        <StackPanel Orientation="Horizontal" Spacing="4" Margin="0,2,0,0">
                          <TextBlock Text="{x:Bind ProductPrice, Mode=OneWay, Converter={StaticResource PriceFormatConverter}}"
                                     FontSize="12"
                                     Foreground="#367419"/>
                          <TextBlock Text="×" FontSize="12" Foreground="#888"/>
                          <TextBlock Text="{x:Bind Quantity, Mode=OneWay}"
                                     FontSize="12"
                                     FontWeight="Bold"
                                     Foreground="#367419"/>
                        </StackPanel>
                      </StackPanel>
                      
                      <!-- Total Price -->
                      <TextBlock Grid.Column="2"
                                 Text="{x:Bind TotalPrice, Mode=OneWay, Converter={StaticResource PriceFormatConverter}}"
                                 FontSize="13"
                                 FontWeight="Bold"
                                 Foreground="#367419"
                                 VerticalAlignment="Center"/>
                    </Grid>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </StackPanel>
        </Border>

        <!-- Error Message -->
        <Border Background="#FEE2E2"
                CornerRadius="12"
                Padding="16"
                Visibility="{x:Bind ViewModel.ErrorMessage, Converter={StaticResource StringToVisibilityConverter}, Mode=OneWay}">
          <StackPanel Orientation="Horizontal" Spacing="10">
            <FontIcon Glyph="&#xE783;" FontSize="18" Foreground="#EF4444"/>
            <TextBlock Text="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                       FontSize="14"
                       Foreground="#EF4444"
                       TextWrapping="Wrap"
                       VerticalAlignment="Center"/>
          </StackPanel>
        </Border>
        
      </StackPanel>
    </ScrollViewer>

    <!-- Bottom Summary & Submit -->
    <Border Grid.Row="2"
            Background="White"
            Padding="16"
            BorderThickness="0,1,0,0"
            BorderBrush="#E8E8E8">
      <Grid RowDefinitions="Auto,Auto">
        
        <!-- Total Row -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,12">
          <StackPanel Grid.Column="0">
            <TextBlock Text="Tổng cộng"
                       FontSize="14"
                       Foreground="#666"/>
            <TextBlock FontSize="12" Foreground="#888">
              <Run Text="{x:Bind ViewModel.CartItems.Count, Mode=OneWay}"/>
              <Run Text=" sản phẩm"/>
            </TextBlock>
          </StackPanel>
          <TextBlock Grid.Column="1"
                     Text="{x:Bind ViewModel.TotalPriceFormatted, Mode=OneWay}"
                     FontSize="24"
                     FontWeight="Bold"
                     Foreground="#367419"
                     VerticalAlignment="Center"/>
        </Grid>
        
        <!-- Submit Button -->
        <Button Grid.Row="1"
                Style="{StaticResource NoHoverPrimaryButtonStyle}"
                Command="{x:Bind ViewModel.SubmitOrderCommand}">
          <Grid ColumnDefinitions="Auto,*">
            <ProgressRing Grid.Column="0"
                          IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                          Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}"
                          Width="20" Height="20"
                          Foreground="White"
                          Margin="0,0,10,0"/>
            <TextBlock Grid.Column="1" 
                       Text="✓ Xác nhận đặt hàng" 
                       FontSize="16" 
                       FontWeight="Bold"
                       Foreground="White"
                       HorizontalAlignment="Center"/>
          </Grid>
        </Button>
      </Grid>
    </Border>

    <!-- Loading Overlay -->
    <components:LoadingIndicator Grid.RowSpan="3"
                                IsLoading="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                                Message="Đang xử lý..."/>
  </Grid>
</Page>
