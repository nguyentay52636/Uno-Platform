# ğŸ—„ï¸ KIáº¾N TRÃšC DATABASE - UNO PLATFORM

## ğŸ“‹ Tá»•ng Quan

á»¨ng dá»¥ng Uno Platform cá»§a báº¡n sá»­ dá»¥ng **2 há»‡ thá»‘ng database khÃ¡c nhau** tÃ¹y theo platform:

| Platform | Database Type | LÃ½ Do |
|----------|--------------|-------|
| **WebAssembly** | In-Memory (RAM) | WASM khÃ´ng há»— trá»£ SQLite/EF Core |
| **Android/iOS/Windows** | SQLite + Entity Framework Core | CÃ³ thá»ƒ lÆ°u trá»¯ persistent data |

---

## ğŸ”„ ÄÆ¯á»œNG ÄI Cá»¦A CODE

### 1ï¸âƒ£ **Khá»Ÿi Äá»™ng á»¨ng Dá»¥ng**

```mermaid
graph TD
    A[App.xaml.cs - OnLaunched] --> B{Platform?}
    B -->|WebAssembly| C[Skip EF Core Init]
    B -->|Android/iOS/Windows| D[Initialize EF Core]
    C --> E[ServiceLocator.DataSeedService.SeedDataAsync]
    D --> E
    E --> F[App Ready]
```

#### ğŸ“„ File: [App.xaml.cs](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/App.xaml.cs)

```csharp
protected override void OnLaunched(LaunchActivatedEventArgs args)
{
    // ...
    InitializeDatabase();  // â† Báº®T Äáº¦U Táº I ÄÃ‚Y
    // ...
}

private async Task InitializeDatabaseAsync()
{
#if !__WASM__
    // CHá»ˆ CHáº Y TRÃŠN ANDROID/iOS/WINDOWS
    using (var dbContext = new Database.EfAppDbContext())
    {
        await dbContext.Database.EnsureCreatedAsync();
    }
#endif
    
    // CHáº Y TRÃŠN Táº¤T Cáº¢ PLATFORMS
    await ServiceLocator.DataSeedService.SeedDataAsync();
}
```

> [!IMPORTANT]
> Directive `#if !__WASM__` lÃ  chÃ¬a khÃ³a! Code bÃªn trong chá»‰ compile cho non-WASM platforms.

---

### 2ï¸âƒ£ **Cáº¥u TrÃºc Database Layer**

```mermaid
graph LR
    A[Repository Layer] --> B{Platform Check}
    B -->|__WASM__| C[InMemoryDbContext]
    B -->|!__WASM__| D[AppDbContext SQLite]
    B -->|!__WASM__| E[EfAppDbContext EF Core]
    
    C --> F[List in RAM]
    D --> G[SQLite File]
    E --> H[SQLite File via EF]
```

---

## ğŸ“ CÃC FILE DATABASE QUAN TRá»ŒNG

### ğŸ”µ **1. InMemoryDbContext.cs** (CHá»ˆ CHO WASM)

ğŸ“ [Database/InMemoryDbContext.cs](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Database/InMemoryDbContext.cs)

```csharp
// KHÃ”NG CÃ“ #if directive - luÃ´n compile
// NHÆ¯NG chá»‰ Ä‘Æ°á»£c sá»­ dá»¥ng trong DatabaseService khi __WASM__

public class InMemoryDbContext
{
    private readonly List<Product> _products = new();
    private readonly List<CartItem> _cartItems = new();
    
    // Táº¥t cáº£ data lÆ°u trong RAM
    // Máº¥t háº¿t khi refresh browser!
}
```

**Äáº·c Ä‘iá»ƒm:**
- âœ… Data lÆ°u trong `List<T>` trong RAM
- âŒ Máº¥t data khi refresh page
- âœ… Nhanh, khÃ´ng cáº§n file I/O
- âœ… Hoáº¡t Ä‘á»™ng trong browser

---

### ğŸŸ¢ **2. AppDbContext.cs** (CHá»ˆ CHO ANDROID/iOS/WINDOWS)

ğŸ“ [Database/AppDbContext.cs](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Database/AppDbContext.cs)

```csharp
#if !__WASM__  // â† CHá»ˆ COMPILE KHI KHÃ”NG PHáº¢I WASM
using SQLite;

public class AppDbContext
{
    private SQLiteConnection? _connection;
    private const string DatabaseFileName = "unoplatform.db";
    
    private string GetDatabasePath()
    {
#if __ANDROID__
        // Android: /data/data/com.companyname.uno-platform/files/
        string personalFolder = Environment.GetFolderPath(
            Environment.SpecialFolder.Personal);
        return Path.Combine(personalFolder, DatabaseFileName);
#else
        // Windows: C:\Users\...\AppData\Local\Packages\...\LocalState\
        string localFolder = ApplicationData.Current.LocalFolder.Path;
        return Path.Combine(localFolder, DatabaseFileName);
#endif
    }
}
#endif  // â† Káº¾T THÃšC BLOCK !__WASM__
```

**Äáº·c Ä‘iá»ƒm:**
- âœ… Data persistent (lÆ°u vÄ©nh viá»…n)
- âœ… Sá»­ dá»¥ng SQLite native
- âœ… File `.db` trÃªn disk
- âŒ KhÃ´ng compile cho WASM

---

### ğŸŸ¡ **3. EfAppDbContext.cs** (CHá»ˆ CHO ANDROID/iOS/WINDOWS)

ğŸ“ [Database/EfAppDbContext.cs](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Database/EfAppDbContext.cs)

```csharp
#if !__WASM__  // â† CHá»ˆ COMPILE KHI KHÃ”NG PHáº¢I WASM
using Microsoft.EntityFrameworkCore;

public class EfAppDbContext : DbContext
{
    public DbSet<CartItem> CartItems { get; set; }
    
    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        string dbPath = GetDatabasePath();
        optionsBuilder.UseSqlite($"Data Source={dbPath}");
    }
    
    private string GetDatabasePath()
    {
#if __ANDROID__
        // Android: /data/data/.../files/cart.db
        string personalFolder = Environment.GetFolderPath(
            Environment.SpecialFolder.Personal);
        return Path.Combine(personalFolder, "cart.db");
#else
        // Windows: AppData\Local\...\cart.db
        string localFolder = ApplicationData.Current.LocalFolder.Path;
        return Path.Combine(localFolder, "cart.db");
#endif
    }
}
#endif
```

**Äáº·c Ä‘iá»ƒm:**
- âœ… Sá»­ dá»¥ng Entity Framework Core
- âœ… LINQ queries
- âœ… Migrations support
- âŒ KhÃ´ng compile cho WASM

---

## ğŸ¯ SERVICE LAYER - NÆ I QUYáº¾T Äá»ŠNH Sá»¬ Dá»¤NG DB NÃ€O

### ğŸ“„ [Services/DatabaseService.cs](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Services/DatabaseService.cs)

ÄÃ¢y lÃ  file **QUAN TRá»ŒNG NHáº¤T** - nÆ¡i quyáº¿t Ä‘á»‹nh dÃ¹ng DB nÃ o!

```csharp
public class DatabaseService
{
#if __WASM__
    // ========== WASM VERSION ==========
    private readonly InMemoryDbContext _dbContext;
    
    public DatabaseService()
    {
        _dbContext = new InMemoryDbContext();  // â† RAM only
    }
    
    public List<Product> GetAllProducts()
    {
        return _dbContext.GetAllProducts();  // â† Tá»« List<T>
    }
    
#else
    // ========== ANDROID/iOS/WINDOWS VERSION ==========
    private readonly AppDbContext _dbContext;
    
    public DatabaseService()
    {
        _dbContext = new AppDbContext();  // â† SQLite
    }
    
    public List<Product> GetAllProducts()
    {
        return _dbContext.Connection.Table<Product>().ToList();  // â† Tá»« SQLite
    }
#endif
}
```

> [!CAUTION]
> CÃ¹ng 1 class [DatabaseService](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Services/DatabaseService.cs#6-235) nhÆ°ng cÃ³ **2 implementations hoÃ n toÃ n khÃ¡c nhau** dá»±a vÃ o platform!

---

## ğŸ”§ Cáº¤U HÃŒNH TRONG .CSPROJ

ğŸ“ [Uno_Platform.csproj](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Uno_Platform.csproj)

```xml
<Project Sdk="Uno.Sdk">
  <PropertyGroup>
    <!-- Äá»‹nh nghÄ©a 3 platforms -->
    <TargetFrameworks>
      net9.0-android;
      net9.0-browserwasm;
      net9.0-windows10.0.19041.0
    </TargetFrameworks>
  </PropertyGroup>

  <!-- Packages cho Táº¤T Cáº¢ platforms -->
  <ItemGroup>
    <PackageReference Include="CommunityToolkit.Mvvm" />
    <PackageReference Include="sqlite-net-pcl" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" />
    <PackageReference Include="Microsoft.EntityFrameworkCore" />
  </ItemGroup>
  
  <!-- Package CHá»ˆ CHO non-WASM platforms -->
  <ItemGroup Condition="'$(TargetFramework)' != 'net9.0-browserwasm'">
    <PackageReference Include="SQLitePCLRaw.bundle_green" />
  </ItemGroup>
</Project>
```

**Giáº£i thÃ­ch:**
- `sqlite-net-pcl`: Wrapper cho SQLite (nhÆ°ng khÃ´ng hoáº¡t Ä‘á»™ng trÃªn WASM)
- `Microsoft.EntityFrameworkCore.Sqlite`: EF Core cho SQLite (khÃ´ng hoáº¡t Ä‘á»™ng trÃªn WASM)
- `SQLitePCLRaw.bundle_green`: Native SQLite binaries (**CHá»ˆ** cho Android/iOS/Windows)

---

## ğŸ”€ REPOSITORY PATTERN

### ğŸ“„ [Repositories/ProductRepository.cs](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Repositories)

```csharp
public class ProductRepository : IProductRepository
{
    private readonly DatabaseService _databaseService;
    
    public ProductRepository()
    {
        _databaseService = new DatabaseService();
        // â†‘ DatabaseService tá»± Ä‘á»™ng chá»n implementation dá»±a vÃ o platform
    }
    
    public async Task<List<Product>> GetAllAsync()
    {
        return await Task.Run(() => _databaseService.GetAllProducts());
        // â†‘ TrÃªn WASM: láº¥y tá»« List<T> trong RAM
        // â†‘ TrÃªn Android: láº¥y tá»« SQLite file
    }
}
```

---

## ğŸ“Š SO SÃNH CHI TIáº¾T

| TÃ­nh NÄƒng | WebAssembly | Android/iOS/Windows |
|-----------|-------------|---------------------|
| **Database Type** | In-Memory List | SQLite File |
| **Persistence** | âŒ Máº¥t khi refresh | âœ… LÆ°u vÄ©nh viá»…n |
| **File Location** | N/A (RAM only) | `/data/data/.../files/` (Android)<br>`AppData\Local\...` (Windows) |
| **DbContext** | [InMemoryDbContext](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Database/InMemoryDbContext.cs#5-79) | [AppDbContext](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Database/AppDbContext.cs#9-58) + [EfAppDbContext](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Database/EfAppDbContext.cs#9-67) |
| **Query Method** | LINQ on `List<T>` | SQLite queries |
| **Package Dependencies** | KhÃ´ng cáº§n SQLite packages | `SQLitePCLRaw.bundle_green` |
| **Compile Directives** | `#if __WASM__` | `#if !__WASM__` |

---

## ğŸš€ FLOW KHI THÃŠM Sáº¢N PHáº¨M Má»šI

````carousel
### WebAssembly Flow

```mermaid
sequenceDiagram
    participant UI as ProductPage
    participant Repo as ProductRepository
    participant DB as DatabaseService
    participant Mem as InMemoryDbContext
    
    UI->>Repo: AddAsync(product)
    Repo->>DB: AddProduct(product)
    DB->>Mem: AddProduct(product)
    Mem->>Mem: _products.Add(product)
    Note over Mem: LÆ°u trong RAM
    Mem-->>DB: true
    DB-->>Repo: true
    Repo-->>UI: Success
```

<!-- slide -->

### Android Flow

```mermaid
sequenceDiagram
    participant UI as ProductPage
    participant Repo as ProductRepository
    participant DB as DatabaseService
    participant SQLite as AppDbContext
    participant File as SQLite File
    
    UI->>Repo: AddAsync(product)
    Repo->>DB: AddProduct(product)
    DB->>SQLite: Connection.Insert(product)
    SQLite->>File: Write to unoplatform.db
    Note over File: Persistent storage
    File-->>SQLite: Success
    SQLite-->>DB: rows > 0
    DB-->>Repo: true
    Repo-->>UI: Success
```
````

---

## ğŸ“ TÃ“M Táº®T ÄÆ¯á»œNG ÄI CODE

### 1. **Khá»Ÿi Ä‘á»™ng app** â†’ [App.xaml.cs](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/App.xaml.cs)
   - Platform check: WASM hay Android?
   - WASM: Skip EF Core init
   - Android: Initialize EF Core database

### 2. **Service Locator** â†’ [ServiceLocator.cs](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Services/ServiceLocator.cs)
   - Táº¡o singleton instances
   - `ProductRepository` â†’ [DatabaseService](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Services/DatabaseService.cs#6-235)

### 3. **Database Service** â†’ [DatabaseService.cs](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Services/DatabaseService.cs)
   - `#if __WASM__`: DÃ¹ng [InMemoryDbContext](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Database/InMemoryDbContext.cs#5-79)
   - `#else`: DÃ¹ng [AppDbContext](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Database/AppDbContext.cs#9-58) (SQLite)

### 4. **Database Context**
   - **WASM**: [InMemoryDbContext](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Database/InMemoryDbContext.cs#5-79) â†’ `List<T>` trong RAM
   - **Android**: [AppDbContext](file:///C:/Users/T480s/Desktop/Uno-Platform/Uno_Platform/Uno_Platform/Database/AppDbContext.cs#9-58) â†’ SQLite file trÃªn disk

### 5. **UI Layer** â†’ Views/ViewModels
   - Gá»i Repository
   - Repository gá»i DatabaseService
   - DatabaseService tá»± Ä‘á»™ng dÃ¹ng Ä‘Ãºng implementation

---

## ğŸ’¡ VÃ Dá»¤ THá»°C Táº¾

### Khi user click "ThÃªm sáº£n pháº©m" trÃªn WebAssembly:

```
ProductPage.xaml.cs
  â†“
ProductViewModel.AddProductCommand
  â†“
ServiceLocator.ProductRepository.AddAsync()
  â†“
DatabaseService.AddProduct()  [WASM version]
  â†“
InMemoryDbContext.AddProduct()
  â†“
_products.Add(product)  â† LÆ°u trong RAM
```

### Khi user click "ThÃªm sáº£n pháº©m" trÃªn Android:

```
ProductPage.xaml.cs
  â†“
ProductViewModel.AddProductCommand
  â†“
ServiceLocator.ProductRepository.AddAsync()
  â†“
DatabaseService.AddProduct()  [Android version]
  â†“
AppDbContext.Connection.Insert(product)
  â†“
SQLite writes to /data/data/.../unoplatform.db  â† LÆ°u vÄ©nh viá»…n
```

---

## ğŸ” DEBUG TIPS

### Kiá»ƒm tra platform hiá»‡n táº¡i:

```csharp
#if __WASM__
    Debug.WriteLine("Running on WebAssembly - Using InMemory DB");
#elif __ANDROID__
    Debug.WriteLine("Running on Android - Using SQLite");
#elif WINDOWS
    Debug.WriteLine("Running on Windows - Using SQLite");
#endif
```

### Xem database path (Android only):

```csharp
#if __ANDROID__
var dbPath = Path.Combine(
    Environment.GetFolderPath(Environment.SpecialFolder.Personal),
    "unoplatform.db"
);
Debug.WriteLine($"Database location: {dbPath}");
#endif
```

---

> [!TIP]
> **Táº¡i sao cáº§n 2 há»‡ thá»‘ng khÃ¡c nhau?**
> - WebAssembly cháº¡y trong browser sandbox, khÃ´ng cÃ³ quyá»n truy cáº­p file system
> - SQLite cáº§n native code, khÃ´ng thá»ƒ compile sang WebAssembly
> - In-memory lÃ  giáº£i phÃ¡p duy nháº¥t cho WASM, nhÆ°ng máº¥t data khi refresh

> [!WARNING]
> **LÆ°u Ã½ quan trá»ng:**
> - Data trÃªn WASM **khÃ´ng persistent** - máº¥t khi refresh
> - Náº¿u cáº§n lÆ°u data trÃªn WASM, pháº£i dÃ¹ng `localStorage` hoáº·c `IndexedDB`
> - Android vÃ  WASM cÃ³ **2 databases hoÃ n toÃ n riÃªng biá»‡t**
